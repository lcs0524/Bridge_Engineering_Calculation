# 距离计算修正说明

## 问题描述
用户指出了计算逻辑中的关键问题：
1. 两个桩都在原有路基外侧，而不是在路基里面
2. 单桩对原有路基中间点位沉降量，不可能大于近桩侧边点的沉降量
3. 用x和z值求解的r，在荷载不变的基础上应该满足勾股定理，R越大沉降越小

## 原有问题
1. **距离计算不完整**：只计算了平面距离 `sqrt((x-pile_x)² + (y-pile_y)²)`，没有考虑深度z的影响
2. **坐标系定义混乱**：Y坐标和Z坐标的含义不清楚
3. **物理逻辑错误**：没有正确体现"距离越远，沉降越小"的基本规律

## 修正内容

### 1. 坐标系重新定义
- **X轴**：沿路基横向，0为路基中心线，负值为左侧，正值为右侧
- **Y轴**：沿路线方向，桩位于Y=0断面
- **Z轴**：地面以下深度，正值表示向下的深度

### 2. 桩位置修正
```python
def _get_pile_position(self, pile_number, road_params):
    if pile_number == 1:
        # 桩1位置（在路基左侧外）
        x = -(road_params['width']/2 + road_params['pile1_distance'])
        y = 0  # 桩位于Y=0断面
    else:
        # 桩2位置（在路基右侧外）
        x = (road_params['width']/2 + road_params['pile2_distance'])
        y = 0  # 桩位于Y=0断面
    return x, y
```

### 3. 距离计算修正
```python
# 修正前：只计算平面距离
distance1 = math.sqrt((x - pile1_x)**2 + (y - pile1_y)**2)

# 修正后：使用3D距离，符合勾股定理
distance1 = math.sqrt((x - pile1_x)**2 + (y - pile1_y)**2 + z**2)
```

### 4. 计算点分布优化
```python
# 16个标准计算点（4x4网格）
x_positions = [-width/3, -width/6, width/6, width/3]  # 路基横向4个位置
y_positions = [0, 5, 10, 15]  # 沿路线方向4个位置
z_depths = [2, 5, 10, 15]     # 4个深度层
```

## 物理逻辑验证

### 测试结果示例
- 路基宽度：20m
- 桩1位置：X = -15.0m（路基左侧外5m）
- 桩2位置：X = 15.0m（路基右侧外5m）

**验证结果**：
- 中心点到桩1平均距离：19.66m
- 左侧边缘点到桩1平均距离：14.68m
- ✓ 正确：中心点距离 > 边缘点距离

- 中心点到桩2平均距离：19.66m
- 右侧边缘点到桩2平均距离：14.68m
- ✓ 正确：中心点距离 > 边缘点距离

## 理论依据

### Boussinesq理论公式
垂直位移公式：
```
ω = P/(4πG) × [z²/R³ + 2(1-ν)/R]
```
其中：R = sqrt(x² + y² + z²)

这表明沉降与距离R成反比关系，距离越大沉降越小。

### 物理规律确认
1. **距离越大，沉降越小**：符合Boussinesq理论的基本规律
2. **路基中心点沉降小于边缘点**：当两桩都在路基外侧时，这是合理的
3. **3D距离计算**：考虑了深度影响，更符合实际物理情况

## 后续计算流程
修正后的距离将用于：
1. 修正系数计算
2. Boussinesq理论沉降计算
3. 相互作用系数计算
4. 物理逻辑验证

这确保了整个计算过程的物理合理性和数值准确性。 